name: Compress SVG files (ImgBot-like)

on:
  # push:
  #   branches-ignore: [compress-svgs-*]
  #   paths:
  #     - "**/*.svg"
  workflow_dispatch:

jobs:
  compress:
    runs-on: macos-latest
    # Skip if the push is from the compression bot itself
    if: github.actor != 'github-actions[bot]' && !startsWith(github.ref_name, 'compress-svgs-')
    
    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Setup Node
        uses: ./.github/actions/composite/setupNode

      - name: Check for existing compression PRs
        id: check_existing
        run: |
          # Check if there's already an open PR with compression
          EXISTING_PR=$(gh pr list --state open --label "compression" --limit 1 --json number --jq '.[0].number')
          if [ ! -z "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "⚠️ Found existing compression PR #$EXISTING_PR, skipping to avoid spam"
          else
            echo "existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compress SVG files
        id: compress
        if: steps.check_existing.outputs.existing_pr != 'true'
        uses: ./.github/actions/javascript/compressSvg

      - name: Create Pull Request
        if: steps.compress.outputs.has_changes == 'true' && steps.check_existing.outputs.existing_pr != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Compress SVG files"
          title: "Compress SVG files"
          body: |
            This automated PR was created to compress SVG files and reduce repository size.
            *This PR will be automatically updated if more SVG files are added and need compression.*
            ---
            ${{ steps.compress.outputs.markdown }}
            
          branch: compress-svgs-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            compression
            svg
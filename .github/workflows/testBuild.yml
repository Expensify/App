name: Build and deploy apps for testing

on:
  workflow_dispatch:
    inputs:
      # If not specified, only build iOS and Android apps from the main branch of Expensify/App
      APP_PULL_REQUEST_NUMBER:
        description: Expensify/App PR number for correct placement of apps. Default to main.
        required: false
        default: ''
      # Pull Request number from Mobile-Expensify repo for correct placement of OD app. It will take precedence over MOBILE-EXPENSIFY from App's PR description if both are specified. If nothing is specified defaults to Mobile-Expensify's main
      MOBILE_EXPENSIFY_PULL_REQUEST_NUMBER:
        description: Expensify/Mobile-Expensify PR number. Defaults to main. Overrides MOBILE-EXPENSIFY set in App's PR description.
        required: false
        default: ''
      REVIEWED_CODE:
        description: I reviewed this pull request and verified that it does not contain any malicious code.
        type: boolean
        required: true
        default: false

env:
  # This variable is needed for fastlane to construct correct path
  PULL_REQUEST_NUMBER: ${{ inputs.APP_PULL_REQUEST_NUMBER || github.event.number }}

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      APP_REF: ${{ steps.getHeadRef.outputs.REF || 'main' }}
    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

  desktop:
    name: Build and deploy Desktop for testing
    needs: [prep]
    runs-on: macos-14-large
    steps:
      - name: Checkout
        # v4
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          ref: ${{ needs.prep.outputs.APP_REF }}

      - name: Create .env.adhoc file based on staging and add PULL_REQUEST_NUMBER env to it
        run: |
          cp .env.staging .env.adhoc
          sed -i '' 's/ENVIRONMENT=staging/ENVIRONMENT=adhoc/' .env.adhoc
          echo "PULL_REQUEST_NUMBER=$PULL_REQUEST_NUMBER" >> .env.adhoc

      - name: Setup Node
        uses: ./.github/actions/composite/setupNode
        with:
          IS_DESKTOP_BUILD: true

      - name: Setup python for node-gyp
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Ensure setuptools for node-gyp
        run: python -m pip install --upgrade pip setuptools

      - name: Build desktop app for testing
        run: npm run desktop-build-adhoc
        env:
          PYTHON: ${{ steps.setup-python.outputs.python-path }}

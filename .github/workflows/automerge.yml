name: Automerge PR

on:
  workflow_dispatch:
    inputs:
      PULL_REQUEST_NUMBER:
        description: The number of the pull request to automerge
        required: true

jobs:
    automerge:
      if: github.actor == 'OSBotify'
      runs-on: ubuntu-latest
      outputs:
        isMergeable: ${{ steps.isPullRequestMergeable.outputs.IS_MERGEABLE }}
      steps:
        - uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f
          with:
            ref: main
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Check if pull request is mergeable
          id: isPullRequestMergeable
          uses: Expensify/Expensify.cash/.github/actions/isPullRequestMergeable@main
          with:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            PULL_REQUEST_NUMBER: ${{ github.event.inputs.PULL_REQUEST_NUMBER }}

        - name: Fail workflow if PR is not mergeable
          if: ${{ steps.isPullRequestMergeable.outputs.IS_MERGEABLE == 'false' }}
          run: exit 1

        # TODO: Once https://github.com/hmarr/auto-approve-action/pull/186 is merged, point back at the non-forked repo
        - name: Check for an auto approve
          # Version: 2.0.0
          uses: roryabraham/auto-approve-action@1d9eaca19e005b39bc4495c51fc7439734b2753d
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            pull-request-number: ${{ github.event.inputs.PULL_REQUEST_NUMBER }}

        # TODO: Once https://github.com/pascalgn/automerge-action/pull/149 is merged, point back at the non-forked repo
        - name: Check for an auto merge
          # Version: 0.12.0
          uses: roryabraham/automerge-action@ab4daa9e8408b60430a4cd8939c3374ecb08f355
          env:
            GITHUB_TOKEN: ${{ secrets.OS_BOTIFY_TOKEN }}
            PULL_REQUEST_NUMBER: ${{ github.event.inputs.PULL_REQUEST_NUMBER }}

        # This Slack step is duplicated in all workflows, if you make a change to this step, make sure to update all
        # the other workflows with the same change
        - uses: 8398a7/action-slack@v3
          name: Job failed Slack notification
          if: ${{ failure() }}
          with:
            status: custom
            fields: workflow, repo
            custom_payload: |
              {
                channel: '#announce',
                attachments: [{
                  color: "#DB4545",
                  pretext: `<!here>`,
                  text: `ðŸ’¥ ${process.env.AS_REPO} failed on ${process.env.AS_WORKFLOW} workflow ðŸ’¥`,
                }]
              }
          env:
            GITHUB_TOKEN: ${{ github.token }}
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

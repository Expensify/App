name: Deploy Help Site
on:
  push:
    branches: [main]

jobs:
  buildAndDeploy:
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: ${{ github.workspace }}/help/Gemfile
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

      - name: Get merged pull request
        id: getMergedPullRequest
        uses: roryabraham/action-get-merged-pull-request@7a7a194f6ff8f3eef58c822083695a97314ebec1
        with:
          github_token: ${{ github.token }}

      - uses: ruby/setup-ruby@08245253a76fa4d1e459b7809579c62bd9eb718a
        with:
          ruby-version: 3.0
          bundler-cache: true

      - name: Build
        run: cd help && bundle exec jekyll build

      - name: Update production branch
        uses: Expensify/App/.github/actions/composite/updateProtectedBranch@main
        with:
          TARGET_BRANCH: gh-pages
          PR_TITLE: 'Deploy help site PR #${{ steps.getMergedPullRequest.outputs.number }}'
          PR_BODY: 'Deploy help site PR #${{ steps.getMergedPullRequest.outputs.number }}'
          OS_BOTIFY_TOKEN: ${{ secrets.OS_BOTIFY_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.LARGE_SECRET_PASSPHRASE }}

      - if: ${{ failure() }}
        uses: Expensify/App/.github/actions/composite/announceFailedWorkflowInSlack@main
        with:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

name: Cherry-pick a pull request

on:
  workflow_dispatch:
    inputs:
      MERGE_COMMIT_SHA:
        description: The merge_commit_sha of the pull request to CP
        required: true
      PULL_REQUEST_NUMBER:
        description: The number of a pull request to CP
        required: true
      CP_TO_PRODUCTION:
        description: Should this pull request also be CP'd to prod?
        required: false
        default: 'false'

jobs:
  if: github.actor == 'OSBotify'
  runs-on: ubuntu-latest

  steps:
    # Version: 2.3.4
    - name: Checkout merge commit
      uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f
      with:
        ref: ${{ github.event.inputs.MERGE_COMMIT_SHA }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create branch for new pull request
      run: git checkout -b cherry-pick-${{ github.event.inputs.PULL_REQUEST_NUMBER }}-staging

    - name: Create Pull Request
      id: createPullRequest
      # Version: 2.4.3
      uses: repo-sync/pull-request@65194d8015be7624d231796ddee1cd52a5023cb3
      with:
        source_branch: ${{ env.HEAD_BRANCH }}
        destination_branch: ${{ github.event.inputs.TARGET_BRANCH }}
        github_token: ${{ secrets.OS_BOTIFY_TOKEN }}
        pr_title: Update version to ${{ env.NEW_VERSION }} on ${{ github.event.inputs.TARGET_BRANCH }}
        pr_body: Update version to ${{ env.NEW_VERSION }}
        pr_label: automerge

    - name: Check if pull request is mergeable
      id: isPullRequestMergeable
      uses: Expensify/Expensify.cash/.github/actions/isPullRequestMergeable@main
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PULL_REQUEST_NUMBER: ${{ steps.createPullRequest.outputs.pr_number }}

    - name: Fail workflow if PR is not mergeable
      if: ${{ steps.isPullRequestMergeable.outputs.IS_MERGEABLE == 'false' }}
      run: exit 1

    # TODO: Once https://github.com/hmarr/auto-approve-action/pull/186 is merged, point back at the non-forked repo
    - name: Check for an auto approve
      # Version: 2.0.0
      uses: roryabraham/auto-approve-action@6bb4a3dcf07664d0131e1c74a4bc6d0d8c849978
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        pull-request-number: ${{ steps.createPullRequest.outputs.pr_number }}

    - name: Check for an auto merge
      # Version: 0.12.0
      uses: pascalgn/automerge-action@39d831e1bb389bd242626bc25d4060064a97181c
      env:
        GITHUB_TOKEN: ${{ secrets.OS_BOTIFY_TOKEN }}
        PULL_REQUEST: ${{ steps.createPullRequest.outputs.pr_number }}

